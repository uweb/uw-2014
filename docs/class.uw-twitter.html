<!DOCTYPE html>

<html>
<head>
  <title>class.uw-twitter.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="404.html">
                404.php
              </a>
            
              
              <a class="source" href="application.html">
                application.php
              </a>
            
              
              <a class="source" href="archive.html">
                archive.php
              </a>
            
              
              <a class="source" href="breadcrumbs.html">
                breadcrumbs.php
              </a>
            
              
              <a class="source" href="comments.html">
                comments.php
              </a>
            
              
              <a class="source" href="content-archive.html">
                content-archive.php
              </a>
            
              
              <a class="source" href="content-image.html">
                content-image.php
              </a>
            
              
              <a class="source" href="content-page.html">
                content-page.php
              </a>
            
              
              <a class="source" href="content-pdf.html">
                content-pdf.php
              </a>
            
              
              <a class="source" href="content.html">
                content.php
              </a>
            
              
              <a class="source" href="footer.html">
                footer.php
              </a>
            
              
              <a class="source" href="functions.html">
                functions.php
              </a>
            
              
              <a class="source" href="header-image.html">
                header-image.php
              </a>
            
              
              <a class="source" href="header.html">
                header.php
              </a>
            
              
              <a class="source" href="image.html">
                image.php
              </a>
            
              
              <a class="source" href="template-functions.html">
                template-functions.php
              </a>
            
              
              <a class="source" href="index.html">
                index.php
              </a>
            
              
              <a class="source" href="uw.html">
                uw.js
              </a>
            
              
              <a class="source" href="menu-mobile.html">
                menu-mobile.php
              </a>
            
              
              <a class="source" href="page.html">
                page.php
              </a>
            
              
              <a class="source" href="search.html">
                search.php
              </a>
            
              
              <a class="source" href="searchform.html">
                searchform.php
              </a>
            
              
              <a class="source" href="class.button-shortcode.html">
                class.button-shortcode.php
              </a>
            
              
              <a class="source" href="class.dropdowns_walker.html">
                class.dropdowns_walker.php
              </a>
            
              
              <a class="source" href="class.filters.html">
                class.filters.php
              </a>
            
              
              <a class="source" href="class.googleapps.html">
                class.googleapps.php
              </a>
            
              
              <a class="source" href="class.images.html">
                class.images.php
              </a>
            
              
              <a class="source" href="class.install.html">
                class.install.php
              </a>
            
              
              <a class="source" href="class.mimes.html">
                class.mimes.php
              </a>
            
              
              <a class="source" href="class.squish_bugs.html">
                class.squish_bugs.php
              </a>
            
              
              <a class="source" href="class.tile-box-shortcode.html">
                class.tile-box-shortcode.php
              </a>
            
              
              <a class="source" href="class.trumba-shortcode.html">
                class.trumba-shortcode.php
              </a>
            
              
              <a class="source" href="class.users.html">
                class.users.php
              </a>
            
              
              <a class="source" href="class.uw-carousel.html">
                class.uw-carousel.php
              </a>
            
              
              <a class="source" href="class.uw-directory.html">
                class.uw-directory.php
              </a>
            
              
              <a class="source" href="class.uw-documentation.html">
                class.uw-documentation.php
              </a>
            
              
              <a class="source" href="class.uw-dropdowns.html">
                class.uw-dropdowns.php
              </a>
            
              
              <a class="source" href="class.uw-enclosure.html">
                class.uw-enclosure.php
              </a>
            
              
              <a class="source" href="class.uw-iframes.html">
                class.uw-iframes.php
              </a>
            
              
              <a class="source" href="class.uw-media-caption.html">
                class.uw-media-caption.php
              </a>
            
              
              <a class="source" href="class.uw-media-credit.html">
                class.uw-media-credit.php
              </a>
            
              
              <a class="source" href="class.uw-oembeds.html">
                class.uw-oembeds.php
              </a>
            
              
              <a class="source" href="class.uw-page-attributes-meta-box.html">
                class.uw-page-attributes-meta-box.php
              </a>
            
              
              <a class="source" href="class.uw-quicklinks.html">
                class.uw-quicklinks.php
              </a>
            
              
              <a class="source" href="class.uw-replace-media.html">
                class.uw-replace-media.php
              </a>
            
              
              <a class="source" href="class.uw-scripts.html">
                class.uw-scripts.php
              </a>
            
              
              <a class="source" href="class.uw-shortcodes.html">
                class.uw-shortcodes.php
              </a>
            
              
              <a class="source" href="class.uw-styles.html">
                class.uw-styles.php
              </a>
            
              
              <a class="source" href="class.uw-tinymce.html">
                class.uw-tinymce.php
              </a>
            
              
              <a class="source" href="class.uw.html">
                class.uw.php
              </a>
            
              
              <a class="source" href="class.youtube-shortcode.html">
                class.youtube-shortcode.php
              </a>
            
              
              <a class="source" href="sidebar.html">
                sidebar.php
              </a>
            
              
              <a class="source" href="template-big-hero.html">
                template-big-hero.php
              </a>
            
              
              <a class="source" href="template-no-hero.html">
                template-no-hero.php
              </a>
            
              
              <a class="source" href="template-no-sidebar.html">
                template-no-sidebar.php
              </a>
            
              
              <a class="source" href="template-no-title.html">
                template-no-title.php
              </a>
            
              
              <a class="source" href="template-small-hero.html">
                template-small-hero.php
              </a>
            
              
              <a class="source" href="thinstrip.html">
                thinstrip.php
              </a>
            
              
              <a class="source" href="class.uw-blogroll.html">
                class.uw-blogroll.php
              </a>
            
              
              <a class="source" href="class.uw-campus-map.html">
                class.uw-campus-map.php
              </a>
            
              
              <a class="source" href="class.uw-intro.html">
                class.uw-intro.php
              </a>
            
              
              <a class="source" href="class.uw-recent-posts.html">
                class.uw-recent-posts.php
              </a>
            
              
              <a class="source" href="class.uw-related-posts.html">
                class.uw-related-posts.php
              </a>
            
              
              <a class="source" href="class.uw-rss.html">
                class.uw-rss.php
              </a>
            
              
              <a class="source" href="class.uw-sidebar.html">
                class.uw-sidebar.php
              </a>
            
              
              <a class="source" href="class.uw-single-image.html">
                class.uw-single-image.php
              </a>
            
              
              <a class="source" href="class.uw-top-posts.html">
                class.uw-top-posts.php
              </a>
            
              
              <a class="source" href="class.uw-twitter.html">
                class.uw-twitter.php
              </a>
            
              
              <a class="source" href="class.uw-widget-visibility.html">
                class.uw-widget-visibility.php
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>class.uw-twitter.php</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-preprocessor">&lt;?php</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p> Twitter widget</p>
<p> Uses the Twitter 1.1 API requiring oAuth authentication just
 to read tweets. Because of the new Twitter request limit this
 widget caches a userâ€™s latest tweets for a minute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
if ( defined( 'TWITTER_OAUTH_TOKEN' ) ) :

class UW_Widget_Twitter extends WP_Widget
{

  const ID                        = 'uw-twitter-feed';
  const SHORTCODE         = 'twitter';
  const NAME                   = 'UW Twitter Feed';
  const DESCRIPTION         = 'Display your latest tweets';
  const CLASSNAME          = 'twitter-feed-widget';

  const URL                      = 'https://api.twitter.com/1.1/statuses/user_timeline.json';
  const AUTHOR_URL        = 'https://api.twitter.com/1.1/users/show.json';
  const REQUESTMETHOD  = 'GET';
  const GETFIELD              = '?include_entities=true&amp;include_rts=true&amp;screen_name=%s&amp;count=%u';
  const RETWEET_TEXT      = '&lt;small&gt;Retweeted by &lt;a href="//twitter.com/%s"&gt; @%s&lt;/a&gt;&lt;/small&gt;';

  const COUNT                 = 5;
  const ACCOUNT             = 'twitter';
  const EXPIRES                 = 60;

  static $SETTINGS = array(
      'oauth_access_token'            =&gt; TWITTER_OAUTH_TOKEN,
      'oauth_access_token_secret'  =&gt; TWITTER_OAUTH_TOKEN_SECRET,
      'consumer_key'                     =&gt;TWITTER_CONSUMER_KEY,
      'consumer_secret'                 =&gt; TWITTER_CONSUMER_SECRET
  );

  function UW_Widget_Twitter()
  {
    parent::WP_Widget(
      $id = self::ID,
      $name = self::NAME,
      $options = array(
          'description' =&gt; self::DESCRIPTION,
          'classname' =&gt; self::CLASSNAME
    ) );

    add_shortcode( self::SHORTCODE , array( $this, 'shortcode' ) );

  }

  function form($instance)
  {
    $title = isset($instance['title']) ? esc_attr($instance['title']) : self::NAME;
    $name  = isset($instance['name']) ? esc_attr($instance['name']) : self::ACCOUNT;
    $count = isset($instance['count']) ? esc_attr($instance['count']) : self::COUNT;
?&gt;
    &lt;p&gt;
    &lt;label for="&lt;?php echo $this-&gt;get_field_id( 'title' ); ?&gt;"&gt;&lt;?php _e( 'Title:' ); ?&gt;&lt;/label&gt;
    &lt;input class="widefat" id="&lt;?php echo $this-&gt;get_field_id( 'title' ); ?&gt;" name="&lt;?php echo $this-&gt;get_field_name( 'title' ); ?&gt;" type="text" value="&lt;?php echo esc_attr( $title ); ?&gt;" /&gt;
    &lt;/p&gt;

    &lt;p&gt;
    &lt;label for="&lt;?php echo $this-&gt;get_field_id( 'name' ); ?&gt;"&gt;&lt;?php _e( 'Twitter screen name:' ); ?&gt;&lt;/label&gt;
    &lt;input class="widefat" id="&lt;?php echo $this-&gt;get_field_id( 'name' ); ?&gt;" name="&lt;?php echo $this-&gt;get_field_name( 'name' ); ?&gt;" type="text" value="&lt;?php echo esc_attr( $name ); ?&gt;" /&gt;
    &lt;/p&gt;

    &lt;p&gt;
    &lt;label for="&lt;?php echo $this-&gt;get_field_id( 'count' ); ?&gt;"&gt;&lt;?php _e( 'Number of tweets to show:' ); ?&gt;&lt;/label&gt;
    &lt;input class="widefat" id="&lt;?php echo $this-&gt;get_field_id( 'count' ); ?&gt;" name="&lt;?php echo $this-&gt;get_field_name( 'count' ); ?&gt;" type="text" value="&lt;?php echo esc_attr( $count ); ?&gt;" /&gt;
    &lt;/p&gt;
&lt;?php
  }

  function update( $new_instance, $old_instance )
  {
    $instance = array();
    $instance['title'] = strip_tags( $new_instance['title'] );
    $instance['name'] = strip_tags( $new_instance['name'] );
    $instance['count'] = intval( $new_instance['count'] );
    return $instance;
  }

  function shortcode( $atts )
  {
    extract( $atts );

    $title = apply_filters( 'widget_title', $title );

    $tweets = $this-&gt;getLatestTweets( $name, $count );

    if ( ! is_array( $tweets ) ) return;
?&gt;

    &lt;?php echo $before_widget; ?&gt;
      &lt;div class="widget uw-twitter"&gt;

        &lt;h3 class="widget-title"&gt;
          &lt;?php echo $before_title;  if ( ! empty( $title ) ) echo $title;  echo $after_title; ?&gt;
        &lt;/h3&gt;

        &lt;div class="twitter-feed" data-name="&lt;?php echo $name; ?&gt;" data-count="&lt;?php echo $count; ?&gt;"&gt;

          &lt;?php foreach ( $tweets as $tweet ) : $tweet = (object) $tweet;  ?&gt;

          &lt;div class="tweet"&gt;
            &lt;a href="//twitter.com/&lt;?php echo $tweet-&gt;author; ?&gt;"&gt;
              &lt;img src="&lt;?php echo $tweet-&gt;img; ?&gt;" alt="&lt;?php echo $tweet-&gt;author; ?&gt;" /&gt;
            &lt;/a&gt;
            &lt;p&gt;
              &lt;a href="//twitter.com/&lt;?php echo $tweet-&gt;author; ?&gt;"&gt;
                &lt;span&gt;@&lt;?php echo $tweet-&gt;author; ?&gt;&lt;/span&gt;
              &lt;/a&gt;
              &lt;?php echo $tweet-&gt;text; ?&gt;
              &lt;?php echo $tweet-&gt;retweet; ?&gt;
            &lt;/p&gt;
          &lt;/div&gt;

          &lt;?php endforeach; ?&gt;

          &lt;a class="more" href="//twitter.com/&lt;?php echo $instance['name'] ?&gt;"&gt;More&lt;/a&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;?php echo $after_widget;?&gt;

&lt;?php
  }

  function widget($args, $instance)
  {
    extract($instance);
    echo do_shortcode( "[twitter title=$title count=$count name=$name ]");
  }


  private function getLatestTweets( $name = 'uw', $count = 5 )
  {

    $transientName = 'twitter-feed-'. $name . '-' . $count;

    if ( false == get_transient( $transientName ) ) {

      $parameters = sprintf(self::GETFIELD, $name, $count );

      $twitter    = new TwitterAPIExchange(self::$SETTINGS);

      $twitter-&gt;setGetfield( $parameters )
              -&gt;buildOauth(self::URL, self::REQUESTMETHOD);

      $tweets = json_decode( $twitter-&gt;performRequest() );

      foreach ($tweets as $index =&gt; $tweet)
      {
        $hasAuthor = ( count($tweet-&gt;entities-&gt;user_mentions) &gt; 0 );
        $retweet   = ( strpos( $tweet-&gt;text , 'RT' ) &gt; 0 );

        $latest[$index]['author'] = $hasAuthor ? $tweet-&gt;entities-&gt;user_mentions[0]-&gt;screen_name :
                                                 $tweet-&gt;user-&gt;screen_name;

        if ( $hasAuthor )
        {

          $twitter-&gt;setGetfield( '?screen_name=' . $latest[$index]['author'] )
                  -&gt;buildOauth( self::AUTHOR_URL, self::REQUESTMETHOD );

          $user = json_decode( $twitter-&gt;performRequest() );

        }

        $latest[$index]['img']    = $hasAuthor ? $user-&gt;profile_image_url_https :
                                                 $tweet-&gt;user-&gt;profile_image_url_https;

        $latest[$index]['text']   = $this-&gt;formatText( $tweet-&gt;text );

        $latest[$index]['retweet'] = $retweet ? sprintf( self::RETWEET_TEXT, $tweet-&gt;user-&gt;screen_name, $tweet-&gt;user-&gt;screen_name ) : '';


      }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>json_encode fixed get_transient returning serialized string instead of array for some tweets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      set_transient( <span class="hljs-variable">$transientName</span> , json_encode( <span class="hljs-variable">$latest</span> ) , <span class="hljs-keyword">self</span>::EXPIRES );
    }

    <span class="hljs-keyword">return</span> json_decode( get_transient( <span class="hljs-variable">$transientName</span> ) );

  }

  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatText</span><span class="hljs-params">( <span class="hljs-variable">$text</span> )</span>
  </span>{

    <span class="hljs-variable">$text</span> = preg_replace( <span class="hljs-string">'/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&amp;~\?\/.=]+/'</span>,
                          <span class="hljs-string">'&lt;a href="\\0"&gt;\\0&lt;/a&gt;'</span>, <span class="hljs-variable">$text</span> );

    <span class="hljs-variable">$text</span> = preg_replace_callback(  <span class="hljs-string">'/[#]+[A-Za-z0-9-_]+/'</span>,
                                    <span class="hljs-keyword">array</span>( <span class="hljs-variable">$this</span>, <span class="hljs-string">'encodeHashTag'</span>),
                                    <span class="hljs-variable">$text</span> );

    <span class="hljs-variable">$text</span> = preg_replace_callback(  <span class="hljs-string">'/[@]+[A-Za-z0-9-_]+/'</span>,
                                    <span class="hljs-keyword">array</span>( <span class="hljs-variable">$this</span>, <span class="hljs-string">'normalizeScreenName'</span>),
                                    <span class="hljs-variable">$text</span> );
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$text</span>;
  }

  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encodeHashTag</span><span class="hljs-params">( <span class="hljs-variable">$hashTag</span> )</span>
  </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a href="//twitter.com/search?q='</span> . urlencode(<span class="hljs-variable">$hashTag</span>[<span class="hljs-number">0</span>]) . <span class="hljs-string">'"&gt; '</span> . <span class="hljs-variable">$hashTag</span>[<span class="hljs-number">0</span>] . <span class="hljs-string">' &lt;/a&gt;'</span>;
  }

  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalizeScreenName</span><span class="hljs-params">( <span class="hljs-variable">$screenname</span> )</span>
  </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a href="//twitter.com/'</span> . str_replace( <span class="hljs-string">'@'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$screenname</span>[<span class="hljs-number">0</span>] ) . <span class="hljs-string">'"&gt;'</span> . <span class="hljs-variable">$screenname</span>[<span class="hljs-number">0</span>] . <span class="hljs-string">'&lt;/a&gt;'</span>;
  }

}

<span class="hljs-keyword">require</span>( get_template_directory() . <span class="hljs-string">'/assets/frameworks/TwitterAPIExchange.php'</span> );

register_widget( <span class="hljs-string">'UW_Widget_Twitter'</span> );

<span class="hljs-keyword">endif</span>;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
